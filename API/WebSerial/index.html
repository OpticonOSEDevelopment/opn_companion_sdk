<!DOCTYPE html>
<!--Example of the Google web serial api to readout the Opticon OPN-2001/PX-20/OPN-6000  by Oscar Jacobse -->
<!--date of last modification: 17/10/2024, tested with Google Chrome Version 130.0.6723.59 -->
<!--21/10/2024 - add the set time command, added download file with the barcode data -->
<!--23/10/2024 - add column with explaination and usage -->
<html>
<head>
  <title>web serial api demo</title>
</head>
<style>
.column {
  float: left;
  width: 50%;
}
</style>
<body>
<div class="column" style="background-color:white;">
<button id="connect">Connect scanner</button><br>
<textarea id="target" name="logwindow" rows="30" cols="50"></textarea><br>
<button id="download">download data</button><br>
</div>
<div class="column" style="background-color:white;">
  	<h1>OPN-2001 live demo</h1>
  	This demo works on the Google Chrome web serial api<br>
	and thus only in Google Chrome&#8482;,&nbsp;Microsoft Edge&#8482; and Opera&#8482;<br>
	At the moment only with Desktop versions of said browsers and not with Mobile versions<br>
	Here you can find more information about the <a href="https://developer.chrome.com/docs/capabilities/serial">web serial api</a><br>
	<br>
	As this is created with client-side scripting (java script) <strong>*no*</strong> data that is downloaded from your Opticon companion scanner is transferred to the internet or Opticon<br>
	The <q>CLEAR_BAR_CODES_CMD</q> is not enabled, after downloading with this live demo the scanner still contains all the barcode data<br>
	You can check the source code your self by saving this page (press CTRL + S) to your computer.<br>
	Please feel free to use this script in your own program/page if you like, permission granted<br> 
	<br>
	<strong>Usage:</strong><br>connect your Opticon companion scanner with an USB cable to your computer and press the <q>Connect scanner</q> button<br>
	Select the correct com port in the popup window and the barcode data is downloaded from the companion scanner<br>
	with the <q>Download data</q> button you can download the barcode data to your computer in a file <q>data.txt</q>
</div>

<script>

"use strict";

const STX = 0x02;
const INTERROGATE_CMD = 0x01;
const CLEAR_BAR_CODES_CMD = 0x02;
const DOWNLOAD_PARAMETERS_CMD = 0x03;
const SPECIAL_CMD = 0x04;
const POWER_DOWN_CMD = 0x05;
const UPLOAD_BAR_CODE_DATA_CMD = 0x07;
const UPLOAD_PARAMETERS_CMD = 0x08;
const SET_TIME_CMD = 0x09;
const GET_TIME_CMD = 0x0A;


const crctab16 = new Uint16Array([
	0x0000, 0xC0C1, 0xC181, 0x0140, 0xC301, 0x03C0, 0x0280, 0xC241,
	0xC601, 0x06C0, 0x0780, 0xC741, 0x0500, 0xC5C1, 0xC481, 0x0440,
	0xCC01, 0x0CC0, 0x0D80, 0xCD41, 0x0F00, 0xCFC1, 0xCE81, 0x0E40,
	0x0A00, 0xCAC1, 0xCB81, 0x0B40, 0xC901, 0x09C0, 0x0880, 0xC841,
	0xD801, 0x18C0, 0x1980, 0xD941, 0x1B00, 0xDBC1, 0xDA81, 0x1A40,
	0x1E00, 0xDEC1, 0xDF81, 0x1F40, 0xDD01, 0x1DC0, 0x1C80, 0xDC41,
	0x1400, 0xD4C1, 0xD581, 0x1540, 0xD701, 0x17C0, 0x1680, 0xD641,
	0xD201, 0x12C0, 0x1380, 0xD341, 0x1100, 0xD1C1, 0xD081, 0x1040,
	0xF001, 0x30C0, 0x3180, 0xF141, 0x3300, 0xF3C1, 0xF281, 0x3240,
	0x3600, 0xF6C1, 0xF781, 0x3740, 0xF501, 0x35C0, 0x3480, 0xF441,
	0x3C00, 0xFCC1, 0xFD81, 0x3D40, 0xFF01, 0x3FC0, 0x3E80, 0xFE41,
	0xFA01, 0x3AC0, 0x3B80, 0xFB41, 0x3900, 0xF9C1, 0xF881, 0x3840,
	0x2800, 0xE8C1, 0xE981, 0x2940, 0xEB01, 0x2BC0, 0x2A80, 0xEA41,
	0xEE01, 0x2EC0, 0x2F80, 0xEF41, 0x2D00, 0xEDC1, 0xEC81, 0x2C40,
	0xE401, 0x24C0, 0x2580, 0xE541, 0x2700, 0xE7C1, 0xE681, 0x2640,
	0x2200, 0xE2C1, 0xE381, 0x2340, 0xE101, 0x21C0, 0x2080, 0xE041,
	0xA001, 0x60C0, 0x6180, 0xA141, 0x6300, 0xA3C1, 0xA281, 0x6240,
	0x6600, 0xA6C1, 0xA781, 0x6740, 0xA501, 0x65C0, 0x6480, 0xA441,
	0x6C00, 0xACC1, 0xAD81, 0x6D40, 0xAF01, 0x6FC0, 0x6E80, 0xAE41,
	0xAA01, 0x6AC0, 0x6B80, 0xAB41, 0x6900, 0xA9C1, 0xA881, 0x6840,
	0x7800, 0xB8C1, 0xB981, 0x7940, 0xBB01, 0x7BC0, 0x7A80, 0xBA41,
	0xBE01, 0x7EC0, 0x7F80, 0xBF41, 0x7D00, 0xBDC1, 0xBC81, 0x7C40,
	0xB401, 0x74C0, 0x7580, 0xB541, 0x7700, 0xB7C1, 0xB681, 0x7640,
	0x7200, 0xB2C1, 0xB381, 0x7340, 0xB101, 0x71C0, 0x7080, 0xB041,
	0x5000, 0x90C1, 0x9181, 0x5140, 0x9301, 0x53C0, 0x5280, 0x9241,
	0x9601, 0x56C0, 0x5780, 0x9741, 0x5500, 0x95C1, 0x9481, 0x5440,
	0x9C01, 0x5CC0, 0x5D80, 0x9D41, 0x5F00, 0x9FC1, 0x9E81, 0x5E40,
	0x5A00, 0x9AC1, 0x9B81, 0x5B40, 0x9901, 0x59C0, 0x5880, 0x9841,
	0x8801, 0x48C0, 0x4980, 0x8941, 0x4B00, 0x8BC1, 0x8A81, 0x4A40,
	0x4E00, 0x8EC1, 0x8F81, 0x4F40, 0x8D01, 0x4DC0, 0x4C80, 0x8C41,
	0x4400, 0x84C1, 0x8581, 0x4540, 0x8701, 0x47C0, 0x4680, 0x8641,
	0x8201, 0x42C0, 0x4380, 0x8341, 0x4100, 0x81C1, 0x8081, 0x4040
]);

const symbologies = new Map([
	[ 0x16,'Bookland' ],
	[ 0x0E,'MSI' ],
	[ 0x02,'Codabar' ],
	[ 0x11,'PDF-417' ],
	[ 0x0c,'Code 11' ],
	[ 0x26,'Postbar (Canada)' ],
	[ 0x20,'Code 32' ],
	[ 0x1e,'Postnet (US)' ],
	[ 0x03,'Code 128' ],
	[ 0x23,'Postal (Australia)' ],
	[ 0x01,'Code 39' ],
	[ 0x22,'Postal (Japan)' ],
	[ 0x13,'Code 39 Full ASCII' ],
	[ 0x27,'Postal (UK)' ],
	[ 0x07,'Code 93' ],
	[ 0x1c,'QR code' ],
	[ 0x1d,'Composite' ],
	[ 0x31,'RSS limited' ],
	[ 0x17,'Coupon' ],
	[ 0x30,'RSS-14' ],
	[ 0x04,'D25' ],
	[ 0x32,'RSS Expanded' ],
	[ 0x1b,'Data Matrix' ],
	[ 0x24,'Signature' ],
	[ 0x0f,'EAN-128' ],
	[ 0x15,'Trioptic Code 39' ],
	[ 0x0b,'EAN-13' ],
	[ 0x08,'UPCA' ],
	[ 0x4b,'EAN-13+2' ],
	[ 0x48,'UPCA+2' ],
	[ 0x8b,'EAN-13+5' ],
	[ 0x88,'UPCA+5' ],
	[ 0x0a,'EAN-8' ],
	[ 0x09,'UPCE' ],
	[ 0x4a,'EAN-8+2' ],
	[ 0x49,'UPCE+2' ],
	[ 0x8a,'EAN-8+5' ],
	[ 0x89,'UPCE+5' ],
	[ 0x05,'IATA' ],
	[ 0x10,'UPCE1' ],
	[ 0x19,'ISBT-128' ],
	[ 0x50,'UPCE1+2' ],
	[ 0x21,'ISBT-128 concatenated' ],
	[ 0x90,'UPCE1+5' ],
	[ 0x06,'ITF' ],
	[ 0x28,'Macro PDF' ]
]);

var output = "";

function crc16(data,end) {
	var res = 0x0ffff;

    for(let i=0; i < end;i++ ) {
        res = ((res >> 8) & 0x0ff) ^ crctab16[(res ^ data[i]) & 0xff];
    }
    return (~res) & 0x0ffff;
}



document.getElementById('connect').addEventListener('click', () => {
  if (navigator.serial) {
    connectSerial();
  } else {
    alert('Web Serial API not supported.');
  }
});

document.getElementById('download').addEventListener('click', () => {
	const blob = new Blob([output], {
		type: "text/plain;charset=utf-8;",
	});
	const blobURL = window.URL.createObjectURL(blob);
	const tempLink = document.createElement('a');
	tempLink.style.display = 'none';
	tempLink.href = blobURL;
	tempLink.setAttribute('download', 'data.txt');
	document.body.appendChild(tempLink);
	tempLink.click();
	document.body.removeChild(tempLink);
	window.URL.revokeObjectURL(blobURL);
});


async function connectSerial() {
	const log = document.getElementById('target');
	var my_command = INTERROGATE_CMD;
	var tx_length;
	var stop = false;
	var softw_version;
	let packet = new Uint8Array(15);
	try {
		const port = await navigator.serial.requestPort();
		await port.open({ baudRate: 9600, bufferSize: 4096 });
		while(!stop) {
			const writer = port.writable.getWriter();
			console.log('command = ' + my_command.toString(16) + '\r\n');
			switch(my_command) {
				case INTERROGATE_CMD:
					output = "";
					tx_length = 0;
					packet[tx_length++] = INTERROGATE_CMD;
					packet[tx_length++] = STX;
					packet[tx_length++] = 0;
				break;
			
				case GET_TIME_CMD:
					tx_length = 0;
					packet[tx_length++] = GET_TIME_CMD;
					packet[tx_length++] = STX;
					packet[tx_length++] = 0;
				break;
				
				case UPLOAD_BAR_CODE_DATA_CMD:
					tx_length = 0;
					packet[tx_length++] = UPLOAD_BAR_CODE_DATA_CMD;
					packet[tx_length++] = STX;
					packet[tx_length++] = 0;
				break;
				
				case POWER_DOWN_CMD:
					tx_length = 0;
					packet[tx_length++] = POWER_DOWN_CMD;
					packet[tx_length++] = STX;
					packet[tx_length++] = 0;
				break;
				
				case CLEAR_BAR_CODES_CMD:
					tx_length = 0;
					packet[tx_length++] = CLEAR_BAR_CODES_CMD;
					packet[tx_length++] = STX;
					packet[tx_length++] = 0;
				break;
				
				case SET_TIME_CMD:
					const seconds = Date.now();
					const pctime = new Date(seconds);
					tx_length = 0;
					packet[tx_length++] = SET_TIME_CMD;
					packet[tx_length++] = STX;
					packet[tx_length++] = 6;
					packet[tx_length++] = pctime.getSeconds();			// Seconds 0-59
					packet[tx_length++] = pctime.getMinutes();			// Minutes 0-59
					packet[tx_length++] = pctime.getHours();			// Hours 0-23
					packet[tx_length++] = pctime.getDate();				// Days 1-31
					packet[tx_length++] = pctime.getMonth() + 1;		// Months 1 - 12
					packet[tx_length++] = pctime.getFullYear()-2000;	// Years 0 - 99
					packet[tx_length++] = 0;
				break;
			}
			var crc = crc16(packet,tx_length);
			console.log(crc.toString(16));
			packet[tx_length++] = (crc >> 8);
			packet[tx_length++] = (crc & 0xff);
			log.innerHTML += 'TX: ';
			for(let n=0; n < tx_length;n++)
				log.innerHTML += packet[n].toString(16)+',';
			log.innerHTML += '\r\n';
			await writer.write(packet.slice(0,tx_length));
			writer.releaseLock();
			var rx_packet = [];
			try {
				const reader = port.readable.getReader();
				for(;;) {
					const {value , done } = await reader.read();
					if (value) {
						console.log('value length = ' + value.length);
						rx_packet.push(...value);
						if (rx_packet[rx_packet.length - 3] == 0) {
							crc = crc16(rx_packet,rx_packet.length-2);
							if (((crc >> 8) == rx_packet[rx_packet.length-2]) && ((crc & 0xff) == rx_packet[rx_packet.length-1])) {
								console.log('crc OK\r\n');
								reader.releaseLock();
								break;
							}
						}
					}
					if (done) {
						console.log('break on done\r\n');
						reader.releaseLock();
						break;
					}
				}
				if (rx_packet) {
					console.log('rx packet length = ' + rx_packet.length);
					console.log('rx_packet = ' + rx_packet);
					log.innerHTML += 'RX: ';
					for(let n=0; n < rx_packet.length;n++)
						log.innerHTML += rx_packet[n].toString(16)+',';
					log.innerHTML += '\r\n';
					switch(my_command) {
					
						case POWER_DOWN_CMD:
							log.innerHTML += 'done\r\n';
							stop = true;
						break;
					
						case CLEAR_BAR_CODES_CMD:
							log.innerHTML += 'cleared\r\n';
							my_command = POWER_DOWN_CMD;
						break;
						
						
						case SET_TIME_CMD:
							if (rx_packet[0] == 0x06)
								log.innerHTML += 'PC time synced\r\n';
							my_command = POWER_DOWN_CMD;
//  uncomment the line below to clear the barcodes.
// 							my_command = CLEAR_BAR_CODES_CMD;
						break;

						case UPLOAD_BAR_CODE_DATA_CMD:
							var j = 1+1+8;
							while( j < rx_packet.length)
							{
								var length = parseInt(rx_packet[j++]);
								if (length == 0)
									break;
								var symbology = parseInt(rx_packet[j++]);
								log.innerHTML += 'length = ' + length + '\r\n';
								log.innerHTML += 'symbology = '+ symbologies.get(symbology) + '\r\n';
								let barcode="";
								for(let k = 0; k < length-5;k++)
									barcode += String.fromCharCode(rx_packet[j++]);
								log.innerHTML += barcode;
								log.innerHTML += '\r\ntimestamp: ';
								var timestamp = parseInt(rx_packet[j++]);
								timestamp <<= 8;
								timestamp |= parseInt(rx_packet[j++]);
								timestamp <<= 8;
								timestamp |= parseInt(rx_packet[j++]);
								timestamp <<= 8;
								timestamp |= parseInt(rx_packet[j++]);
								console.log(timestamp.toString(16));
								var year = 2000 + (timestamp & 0x3f);
								console.log('year = ' + year.toString());
								timestamp >>= 6;
								var month = (timestamp & 0x0f);
								console.log('month = '+ month.toString());
								timestamp >>= 4;
								var day = (timestamp & 0x1f);
								console.log('day = '+ day.toString());
								timestamp >>= 5;
								var hour = (timestamp & 0x1f);
								console.log('hour = '+ hour.toString());
								timestamp >>= 5;
								var min = (timestamp & 0x3f);
								console.log('min = ' + min.toString());
								timestamp >>= 6;
								var sec = (timestamp & 0x3f);
								console.log('sec = ' + sec.toString());
								log.innerHTML += hour.toString() + ':' + String(min).padStart(2, '0') + ':' + String(sec).padStart(2, '0') + ' ';
								log.innerHTML += day.toString() + '/' + month.toString() + '/' + year.toString() + '\r\n';
								output += barcode;
								output += ',';
								output += symbologies.get(symbology);
								output += ',';
								output += hour.toString() + ':' + String(min).padStart(2, '0') + ':' + String(sec).padStart(2, '0');
								output += ',';
								output += day.toString() + '/' + month.toString() + '/' + year.toString() + '\r\n';
								console.log('output = ' + output);
							}
							my_command = SET_TIME_CMD;
						break;
						
						case GET_TIME_CMD:
							log.innerHTML +=  'date of scanner = ' + rx_packet[6] + '/' + rx_packet[7] + '/20' + rx_packet[8] + '\r\n';
							log.innerHTML +=  'time of scanner = ' + rx_packet[5] + ':' + String(rx_packet[4]).padStart(2, '0') + ':' + String(rx_packet[3]).padStart(2, '0') + '\r\n';
							my_command = UPLOAD_BAR_CODE_DATA_CMD;
						break;
					
						case INTERROGATE_CMD:
							log.innerHTML += 'serial number = ' + rx_packet[4] + rx_packet[5] + rx_packet[6] + rx_packet[7] + rx_packet[8] + rx_packet[9] + rx_packet[10] + rx_packet[11] + '\r';
							log.innerHTML += 'software version = ' + String.fromCharCode(rx_packet[12]) + String.fromCharCode(rx_packet[13]) + String.fromCharCode(rx_packet[14]) +
																	String.fromCharCode(rx_packet[15]) + String.fromCharCode(rx_packet[16]) + String.fromCharCode(rx_packet[17]) +
																	String.fromCharCode(rx_packet[18]) + String.fromCharCode(rx_packet[19]) + '\r\n';
							my_command = GET_TIME_CMD;
						break;
					}
					console.log('command = ' + my_command + 'stop = ' + stop);
				}
			} catch (error) {
				console.log('error = ' + error);
			}
			console.log('loop\r\n');
		}
		await port.close();
	} catch (error) {
		log.innerHTML = error;
	}
}



</script>

</body>
</html> 